components:
  policy-definitions:
    enforceMTLS: &enforceMTLS
      name: "MTLS Enforcement Policy"
      type: "filter-policy"
      description: "Enforces MTLS on the incoming request."
      class: "org.wso2.financial.services.accelerator.identity.extensions.filter.policy.MTLSEnforcementFilterPolicy"
      parameters:
        param_1:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_2:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_3: "value_1"

    publishAccessTokenData: &publishAccessTokenData
      name: "Access Token Data Publishing Policy"
      type: "filter-policy"
      description: "Publish issues access token data."
      class: "org.wso2.financial.services.accelerator.identity.extensions.filter.policy.DataPublishingFilterPolicy"
      parameters:
        param_1:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_2:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_3: "value_1"

    addConsentIdToResponse: &addConsentIdToResponse
      name: "Consent ID to Response Policy"
      type: "filter-policy"
      description: "Add consent ID to the response."
      class: "org.wso2.financial.services.accelerator.identity.extensions.filter.policy.AppendConsentIdFilterPolicy"
      parameters:
        param_1:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_2:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_3: "value_1"

    errorFormatPolicy: &errorFormatPolicy
      name: "Error Format Policy"
      type: "filter-policy"
      description: "Format Error Response."
      class: "org.wso2.financial.services.accelerator.identity.extensions.filter.policy.ErrorFormatFilterPolicy"
      parameters:
        param_1:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_2:
          - key_1: "value_1"
            key_2: "value_2"
            key_3: "value_3"
        param_3: "value_1"

    schemaValidationPolicy: &schemaValidationPolicy
      name: "Schema Validation Policy"
      type: "filter-policy"
      description: "Validate payload against JSON schema."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ConsentSchemaValidationFilterPolicy"
      parameters:
        json_schema_url: "https://gist.githubusercontent.com/Ashi1993/108436ac035b06e2e35604b66791f656/raw/4bd9d25fda6b2e9f634fb5ec882cca91c46fac9b/account-json-schema.json"

    clientIdValidationPolicy: &clientIdValidationPolicy
      name: "ClientId Validation Policy"
      type: "filter-policy"
      description: "Validate client id."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ClientIdValidationFilterPolicy"

    futureDateValidationPolicy: &futureDateValidationPolicy
      name: "FutureDateValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate payload against JSON schema."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.FutureDateValidationFilterPolicy"
      parameters:
        applicable_params:
          - "Data.ExpirationDateTime"

    callExternalAPI: &callExternalAPI
      name: "CallExternalAPI Policy"
      type: "filter-policy"
      description: "Invoke an external service."
      class: "org.wso2.financial.services.accelerator.common.policy.filter.common.ExternalValidationFilterPolicy"
      parameters:
        endpoint: "http://localhost:9766/api/fs/consent/manage/external"
        service_type: "consent"
        security:
          type: "basic-auth" # Change to "oauth2" if needed
          username: ""
          password: ""

apis:
  - name: "TokenAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/token:
        post:
          request-flow:
            policies:
              - *enforceMTLS
          execution-flow:
            policies:
              - *publishAccessTokenData
          response-flow:
            policies:
              - *addConsentIdToResponse

  - name: "AuthorizeAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/authorize:
        get:
          request-flow:
            policies:
              - *enforceMTLS

  - name: "AccountsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/account-access-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "PaymentsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/domestic-payment-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-standing-order-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/file-payment-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-payment-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-standing-order-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.RecurringPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "ConfirmationOfFundsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/funds-confirmation-consents:
        post:
          request-flow:
            policies:
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:

# Global Policies (Applied to all APIs)
global-policies:
  - *errorFormatPolicy
